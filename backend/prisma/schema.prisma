
generator client {
  provider = "prisma-client-js"
}
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid()) 
  email     String   @unique
  title     Title?   
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  contactNo String?  @map("contact_no")
  role      Role     @default(CONSULTANT)
  team      Teams?
  password  String   

  pendingBookings PendingBooking[]
  approvedBookings Booking[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

enum Role {
  ADMIN
  CONSULTANT
  MANAGEMENT
  SUPER_MANAGER
  SUPER_ADMIN
}
enum Teams {
  PH
  TOURS
  MARKETING 
  QC       
  IT      
}
enum Title {
  MR
  MRS
  MS
  DR
  PROF
}


model PendingBooking {
  id                Int             @id @default(autoincrement())
  refNo             String          @map("ref_no")
  paxName           String          @map("pax_name")
  agentName         String          @map("agent_name")
  teamName          Teams?          @map("team_name")
  pnr               String          @map("pnr")
  airline           String          @map("airline")
  fromTo            String          @map("from_to")
  bookingType       BookingType     @map("booking_type")
  bookingStatus     BookingStatus?  @map("booking_status")
  pcDate            DateTime        @map("pc_date")
  issuedDate        DateTime?       @map("issued_date")
  paymentMethod     PaymentMethod   @map("payment_method")
  lastPaymentDate   DateTime?       @map("last_payment_date")
  travelDate        DateTime?       @map("travel_date")
  revenue           Float?          @map("revenue")
  prodCost          Float?          @map("prod_cost")
  transFee          Float?          @map("trans_fee")
  surcharge         Float?          @map("surcharge")
  pendingInitialPayments   PendingInitialPayment[]
  balance           Float?          @map("balance")
  profit            Float?          @map("profit")
  invoiced          String?         @map("invoice")
  description       String?         @map("description")
  status            PendingStatus   @default(PENDING) @map("status")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  instalments       PendingInstalment[]
  passengers        PendingPassenger[]
  supplierCosts PendingSupplierCostItem[]
  numPax            Int             @map("num_pax")

  createdById       String          @map("created_by_id")
  createdBy         User            @relation(fields: [createdById], references: [id])

  @@map("pending_bookings")
}
enum BookingType {
  FRESH
  DATE_CHANGE
  CANCELLATION
}
enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  VOID
}
enum PaymentMethod {
  FULL
  INTERNAL
}
enum PendingStatus {
  PENDING
  APPROVED
  REJECTED
}
model PendingInitialPayment {
  id                Int      @id @default(autoincrement())
  amount            Float
  transactionMethod String   @map("transaction_method")
  paymentDate       DateTime @map("payment_date")

  pendingBookingId  Int?     @map("pending_booking_id")
  pendingBooking    PendingBooking? @relation(fields: [pendingBookingId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("pending_initial_payments") 
}

model PendingInstalment {
  id                Int            @id @default(autoincrement())
  pendingBookingId  Int
  dueDate           DateTime       @map("due_date")
  amount            Float
  status            String         @default("PENDING")
  pendingBooking    PendingBooking @relation(fields: [pendingBookingId], references: [id], onDelete: Cascade)
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  @@map("pending_instalments")
}

model PendingPassenger {
  id                Int               @id @default(autoincrement())
  pendingBookingId  Int
  title             Title
  firstName         String            @map("first_name")
  middleName        String?           @map("middle_name")
  lastName          String            @map("last_name")
  gender            Gender
  email             String?
  contactNo         String?           @map("contact_no")
  nationality       String?           @map("nationality")
  birthday          DateTime?         @map("birthday")
  category          PassengerCategory
  pendingBooking    PendingBooking     @relation(fields: [pendingBookingId], references: [id], onDelete: Cascade)
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  @@map("pending_passengers")
}

enum Gender {
  MALE
  FEMALE
}

enum PassengerCategory {
  ADULT
  CHILD
  INFANT
}

model PendingSupplierCostItem {
  id                Int           @id @default(autoincrement())
  amount            Float
  supplier          Supplier
  category          CostCategory
  description       String?       @map("description")
  
  pendingBookingId  Int           @map("pending_booking_id")
  pendingBooking    PendingBooking @relation(fields: [pendingBookingId], references: [id], onDelete: Cascade)

  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  @@map("pending_supplier_costs")
}

enum Supplier {
  BTRES
  LYCA
  TRIVAGO
  OTHER 
}

enum CostCategory {
  FLIGHT
  HOTEL
  CRUISE
  OTHER
}

model Booking {
  id                Int             @id @default(autoincrement())
  folderNo          String          @unique @map("folder_no") // <--- Q1: Unqiue String ID
  
  refNo             String          @map("ref_no")
  paxName           String          @map("pax_name")
  agentName         String          @map("agent_name")
  teamName          Teams?          @map("team_name")
  numPax            Int             @map("num_pax")
  pnr               String          @map("pnr")
  airline           String          @map("airline")
  fromTo            String          @map("from_to")
  bookingType       BookingType     @map("booking_type")
  bookingStatus     BookingStatus   @default(CONFIRMED) @map("booking_status")
  
  pcDate            DateTime        @map("pc_date")
  travelDate        DateTime?       @map("travel_date")
  
  paymentMethod     PaymentMethod   @map("payment_method")
  revenue           Float?          @map("revenue")
  prodCost          Float?          @map("prod_cost")
  transFee          Float?          @map("trans_fee")
  surcharge         Float?          @map("surcharge")
  profit            Float?          @map("profit")
  balance           Float?          @map("balance")
  
  description       String?         @map("description")
  
  approvedById      String          @map("approved_by_id")
  approvedBy        User            @relation(fields: [approvedById], references: [id])
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // Relations
  initialPayments   InitialPayment[]
  instalments       Instalment[]
  passengers        Passenger[]
  supplierCosts     SupplierCostItem[]
  supplierPayments  SupplierPayment[]

  isSettled         Boolean      @default(false) @map("is_settled")
  settledAt         DateTime?    @map("settled_at")
  transactions      Transaction[]

  @@map("bookings")
}

model InitialPayment {
  id                Int      @id @default(autoincrement())
  amount            Float
  transactionMethod String   @map("transaction_method")
  paymentDate       DateTime @map("payment_date")
  
  bookingId         Int      @map("booking_id")
  booking           Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now()) @map("created_at")
  @@map("initial_payments")
}

model Instalment {
  id                Int            @id @default(autoincrement())
  bookingId         Int            @map("booking_id")
  booking           Booking        @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  dueDate           DateTime       @map("due_date")
  
  amount            Float          @map("expected_amount") // What they SHOULD pay
  paidAmount        Float          @default(0) @map("paid_amount") // What they ACTUALLY paid
  
  type              InstalmentType @default(INSTALMENT)
  
  status            String         @default("PENDING") // PENDING, PAID, PARTIAL
  
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  transactions      Transaction[]
  
  @@map("instalments")
}

enum InstalmentType {
  INSTALMENT
  SETTLEMENT
}

model Passenger {
  id                Int               @id @default(autoincrement())
  bookingId         Int               @map("booking_id")
  booking           Booking           @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  title             Title
  firstName         String            @map("first_name")
  lastName          String            @map("last_name")
  gender            Gender
  category          PassengerCategory
  
  // Optional details
  middleName        String?           @map("middle_name")
  email             String?
  contactNo         String?           @map("contact_no")
  nationality       String?           @map("nationality")
  birthday          DateTime?         @map("birthday")

  @@map("passengers")
}

model SupplierCostItem {
  id                Int           @id @default(autoincrement())
  bookingId         Int           @map("booking_id")
  booking           Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  amount            Float
  paidAmount        Float         @default(0) @map("paid_amount")

  supplier          Supplier
  category          CostCategory
  description       String?       @map("description")

  payments          SupplierPayment[]

  @@map("supplier_costs")
}

model SupplierPayment {
  id                Int               @id @default(autoincrement())
  amount            Float             // Amount sent to supplier
  method            String            // BANK, CARD, CASH, CREDIT
  date              DateTime          @default(now())
  reference         String?           // E.g., Transfer Receipt No.
  
  bookingId         Int               @map("booking_id")
  booking           Booking           @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  supplierCostId    Int               @map("supplier_cost_id")
  supplierCost      SupplierCostItem  @relation(fields: [supplierCostId], references: [id], onDelete: Cascade)

  createdAt         DateTime          @default(now()) @map("created_at")
  @@map("supplier_payments")
}

model Transaction {
  id                Int       @id @default(autoincrement())
  
  amount            Float     // How much received
  method            String    // CASH, BANK, CARD
  date              DateTime  @default(now())
  reference         String?   // Check No, Bank Ref, etc.
  
  bookingId         Int       @map("booking_id")
  booking           Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  instalmentId      Int?      @map("instalment_id")
  instalment        Instalment? @relation(fields: [instalmentId], references: [id])

  createdAt         DateTime  @default(now()) @map("created_at")
  
  @@map("transactions")
}



